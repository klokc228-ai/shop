{% extends 'main/base.html' %}
{% load static %}

{% block title %}Каталог — StylishShop{% endblock %}

{% block extra_head %}
<style>
  .products {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 24px;
  }

  .product {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    transition: transform .2s ease, box-shadow .2s ease;
  }

  .product:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(0,0,0,.5);
  }

  .product a {
    text-decoration: none;
    color: inherit;
  }

  .product img {
    width: 100%;
    height: 300px;
    object-fit: contain;
    border-bottom: 1px solid var(--line);
    background: #0e121a;
    transition: opacity .3s ease;
  }

  .product img:hover {
    opacity: 0.85;
  }

  .product-body {
    padding: 16px;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .product-title {
    font-size: 17px;
    font-weight: 700;
    margin: 0 0 6px;
  }

  .product-desc {
    color: var(--muted);
    font-size: 14px;
    flex-grow: 1;
    margin-bottom: 10px;
  }

  .product-price {
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 6px;
  }

  /* ⭐ блок рейтинга */
  .rating {
    color: #ffd700;
    font-size: 16px;
    margin-bottom: 8px;
    text-shadow: 0 0 8px rgba(255,215,0,0.4);
  }

  .rating span.empty {
    opacity: 0.25;
  }

  .rating small {
    color: #999;
    font-size: 13px;
    display: block;
  }

  .btn {
    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: #0e121a;
    color: var(--text);
    font-weight: 600;
    cursor: pointer;
    transition: background .2s ease, transform .2s ease;
  }

  .btn:hover {
    background: rgba(124,140,255,.2);
    transform: translateY(-2px);
  }
</style>
{% endblock %}

{% block content %}
<h1>Каталог товаров</h1>

<section class="products">
  {% for product in products %}
    <div class="product">
      <a href="{% url 'product_detail' product.slug %}">
        <img src="{{ product.photo.url }}" alt="{{ product.name }}">
      </a>
      <div class="product-body">
        <h3 class="product-title">
          <a href="{% url 'product_detail' product.slug %}">
            {{ product.name }}
          </a>
        </h3>
        <p class="product-desc">{{ product.description|truncatewords:15 }}</p>
        <div class="product-price">{{ product.price }} ₴</div>

        <!-- ⭐ Средняя оценка -->
        <div class="rating">
          {% with avg=product.average_rating %}
            {% for i in "12345" %}
              {% if forloop.counter <= avg %}
                ★
              {% else %}
                <span class="empty">★</span>
              {% endif %}
            {% endfor %}
            <small>{{ avg|floatformat:1 }} из 5 ({{ product.review_count }} отзыв{{ product.review_count|pluralize:",а,ов" }})</small>
          {% endwith %}
        </div>

        <a href="{% url 'add_to_cart' product.slug %}" class="btn">Добавить в корзину</a>
      </div>
    </div>
  {% endfor %}
</section>
{% endblock %}
